"""
–ú–∏–≥—Ä–∞—Ü–∏—è: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∑–∞–ø—á–∞—Å—Ç–µ–π (parts)
–í–µ—Ä—Å–∏—è: 2.2.1
–î–∞—Ç–∞: 03.11.2024
"""

import os
import sys

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –∫–æ—Ä–Ω—é –ø—Ä–æ–µ–∫—Ç–∞
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from app import app, db
from models import Part
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –∑–∞–ø—á–∞—Å—Ç–µ–π –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
PARTS_CATALOG = {
    '–¢–æ—Ä–º–æ–∑–∞': ['–ü–µ—Ä–µ–¥–Ω–∏–µ –∫–æ–ª–æ–¥–∫–∏', '–ó–∞–¥–Ω–∏–µ –∫–æ–ª–æ–¥–∫–∏', '–î–∏—Å–∫–∏ –ø–µ—Ä–µ–¥–Ω–∏–µ', '–î–∏—Å–∫–∏ –∑–∞–¥–Ω–∏–µ', '–¢–æ—Ä–º–æ–∑–Ω–∞—è –∂–∏–¥–∫–æ—Å—Ç—å'],
    '–î–≤–∏–≥–∞—Ç–µ–ª—å': ['–ú–∞—Å–ª–æ –º–æ—Ç–æ—Ä–Ω–æ–µ', '–ú–∞—Å–ª—è–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä', '–í–æ–∑–¥—É—à–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä', '–°–≤–µ—á–∏ –∑–∞–∂–∏–≥–∞–Ω–∏—è', '–†–µ–º–µ–Ω—å –ì–†–ú'],
    '–ü–æ–¥–≤–µ—Å–∫–∞': ['–ê–º–æ—Ä—Ç–∏–∑–∞—Ç–æ—Ä—ã –ø–µ—Ä–µ–¥–Ω–∏–µ', '–ê–º–æ—Ä—Ç–∏–∑–∞—Ç–æ—Ä—ã –∑–∞–¥–Ω–∏–µ', '–ü—Ä—É–∂–∏–Ω—ã', '–°—Ç–æ–π–∫–∏ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ç–æ—Ä–∞', '–†—ã—á–∞–≥–∏'],
    '–≠–ª–µ–∫—Ç—Ä–∏–∫–∞': ['–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä', '–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä', '–°—Ç–∞—Ä—Ç–µ—Ä', '–õ–∞–º–ø—ã', '–î–∞—Ç—á–∏–∫–∏'],
    '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏': ['–ê–Ω—Ç–∏—Ñ—Ä–∏–∑', '–û–º—ã–≤–∞–π–∫–∞', '–°–∞–ª–æ–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä', '–©—ë—Ç–∫–∏ —Å—Ç–µ–∫–ª–æ–æ—á–∏—Å—Ç–∏—Ç–µ–ª—è', '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∂–∏–¥–∫–æ—Å—Ç–∏']
}


def migrate():
    """–ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏"""
    with app.app_context():
        try:
            print("üöÄ –ù–∞—á–∞–ª–æ –º–∏–≥—Ä–∞—Ü–∏–∏: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∑–∞–ø—á–∞—Å—Ç–µ–π")
            
            # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã parts
            print("üìã –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã parts...")
            db.create_all()
            print("‚úÖ –¢–∞–±–ª–∏—Ü–∞ parts —Å–æ–∑–¥–∞–Ω–∞")
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–ø—á–∞—Å—Ç–∏ –≤ –±–∞–∑–µ
            existing_parts = Part.query.count()
            if existing_parts > 0:
                print(f"‚ÑπÔ∏è  –í –±–∞–∑–µ —É–∂–µ –µ—Å—Ç—å {existing_parts} –∑–∞–ø—á–∞—Å—Ç–µ–π, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–º–ø–æ—Ä—Ç")
                return
            
            # –ò–º–ø–æ—Ä—Ç –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞
            print("üì¶ –ò–º–ø–æ—Ä—Ç –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞ –∑–∞–ø—á–∞—Å—Ç–µ–π...")
            total_imported = 0
            
            for category, parts in PARTS_CATALOG.items():
                print(f"  üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category}")
                
                for idx, part_name in enumerate(parts):
                    part = Part(
                        name=part_name,
                        category=category,
                        is_active=True,
                        sort_order=idx
                    )
                    db.session.add(part)
                    total_imported += 1
                    print(f"    ‚úì {part_name}")
            
            db.session.commit()
            print(f"‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ {total_imported} –∑–∞–ø—á–∞—Å—Ç–µ–π")
            
            # –í—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            print("\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
            for category in PARTS_CATALOG.keys():
                count = Part.query.filter_by(category=category).count()
                print(f"  {category}: {count} –∑–∞–ø—á–∞—Å—Ç–µ–π")
            
            print("\n‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: {e}")
            import traceback
            traceback.print_exc()
            db.session.rollback()
            sys.exit(1)


if __name__ == '__main__':
    migrate()
